# Implementation Plan: Kubernetes Deployment with Minikube and Helm

**Branch**: `006-minikube-helm-deployment` | **Date**: 2025-12-18 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/006-minikube-helm-deployment/spec.md`

**Note**: This plan is generated by the `/sp.plan` command following the Spec-Driven Development workflow.

## Summary

Deploy the Phase 3 Todo Chatbot application (Next.js frontend + FastAPI backend with AI agents) to a local Minikube Kubernetes cluster using Helm 3.x charts. The deployment includes health checks (liveness and readiness probes), configuration management (ConfigMaps and Secrets), service configuration (NodePort for frontend, ClusterIP for backend), one-command deployment automation, and AI DevOps tools integration (kubectl-ai, kagent, Docker AI). The application connects to external Neon PostgreSQL database and Cloudflare R2 storage (not in-cluster). Images are built in Minikube's Docker daemon context. All Phase 3 functionality remains intact with no breaking changes.

**Technical Approach**:
- Use Kubernetes API version `apps/v1` for Deployments, `v1` for Services/ConfigMaps/Secrets (verified via Context7)
- Use standard Helm 3 chart structure with `values.yaml`, `templates/`, and `Chart.yaml`
- Build images in Minikube context using `eval $(minikube docker-env)` + `docker build`
- Implement separate HTTP health probes for liveness (process health) and readiness (dependency health)
- Store non-sensitive config in ConfigMaps, sensitive credentials in Secrets
- Expose frontend via NodePort (:30300), backend via ClusterIP (internal only)
- Automate deployment with shell script orchestrating prerequisite checks, image builds, and Helm installation

## Technical Context

**Language/Version**:
- Frontend: Node.js 22+, Next.js 16 (TypeScript)
- Backend: Python 3.13+, FastAPI
- Kubernetes: 1.28+ (Minikube 1.32+)
- Helm: 3.x

**Primary Dependencies**:
- Kubernetes: Minikube (local cluster), kubectl (CLI)
- Helm: 3.x (package manager)
- Docker: 24+ (container runtime via Minikube)
- Existing Phase 3 application (Next.js, FastAPI, OpenAI Agents SDK, MCP tools)

**Storage**:
- External: Neon Serverless PostgreSQL (not in-cluster)
- External: Cloudflare R2 (not in-cluster)
- No persistent volumes required (stateless pods)

**Testing**:
- Deployment verification via quickstart.md scenarios
- Health probe testing (liveness/readiness)
- End-to-end functionality testing (all Phase 3 features)
- Existing Phase 3 automated tests (pytest backend, Jest frontend)

**Target Platform**:
- Local development: Minikube on developer machine (Linux/macOS/Windows)
- Kubernetes 1.28+ compatible
- Single-node cluster sufficient

**Project Type**:
- Infrastructure/deployment (Helm charts, Kubernetes manifests, automation scripts)
- Extends existing web application (Phase 3)

**Performance Goals**:
- Pods reach Ready state within 2 minutes of deployment
- Frontend loads within 5 seconds via NodePort
- Deployment script completes in under 10 minutes
- Health probes restart failed pods within 30 seconds

**Constraints**:
- Minikube only (not k3s, kind, or cloud providers)
- Images built in Minikube Docker context (no external registry)
- External database and storage (no in-cluster persistence)
- All Phase 3 functionality must remain intact
- Stateless pod design (horizontal scaling support)

**Scale/Scope**:
- 2 frontend replicas, 2 backend replicas (configurable)
- Development/testing environment scope
- Single namespace deployment
- Minimal resource footprint for local development

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

### Phase IV Mandatory Requirements Compliance

✅ **Local Kubernetes Cluster**: Application deployable to Minikube 1.32+
✅ **Helm Charts**: Application packaged with Helm 3.x charts
✅ **Health Checks**: Liveness and readiness probes configured for all pods
✅ **Configuration Management**: ConfigMaps (non-sensitive) and Secrets (sensitive)
✅ **Service Configuration**: Frontend (NodePort :30300), Backend (ClusterIP :8000)
✅ **Deployment Automation**: One-command `deploy.sh` script orchestrates full workflow
✅ **AI DevOps Tools**: kubectl-ai, kagent, Docker AI documented with examples

### Technology Stack Compliance

✅ **Kubernetes Platform**: Minikube 1.32+ verified via Context7
✅ **Package Manager**: Helm 3.x verified via Context7
✅ **Container Runtime**: Docker 24+ via Minikube daemon
✅ **Image Building**: Images built in Minikube context (`eval $(minikube docker-env)`)
✅ **External Dependencies**: Neon PostgreSQL and Cloudflare R2 remain external

### Deployment Architecture Compliance

✅ **Stateless Design**: All pods stateless, no persistent volumes
✅ **Horizontal Scaling**: Architecture supports scaling replicas (configurable via Helm values)
✅ **Health Monitoring**: Liveness/readiness probes detect failures, trigger restarts
✅ **Configuration Separation**: Sensitive (Secrets) vs non-sensitive (ConfigMaps)
✅ **No Hardcoded Credentials**: All credentials injected via Kubernetes Secrets

### Success Criteria Compliance

✅ **Pods Ready**: Target <2 minutes (verified via quickstart.md)
✅ **Frontend Accessible**: NodePort :30300, loads <5 seconds
✅ **End-to-End Functionality**: All Phase 3 features work (login, chat, tasks)
✅ **Health Probes**: Restart pods <30 seconds on failure
✅ **No Plaintext Secrets**: Secrets base64 encoded, not visible in logs/specs
✅ **Deployment Script**: Completes <10 minutes
✅ **AI Tools**: kubectl-ai, kagent, Docker AI documented with examples

### Phase 2/3 Preservation

✅ **No Breaking Changes**: All existing Phase 3 functionality intact
✅ **Same Tech Stack**: Next.js 16, FastAPI, OpenAI Agents SDK, MCP tools unchanged
✅ **Same Database**: Neon PostgreSQL connection maintained
✅ **Same Authentication**: Better Auth JWT verification preserved
✅ **Same Features**: Task CRUD, authentication, AI chatbot all functional

**Gate Result**: ✅ **PASS** - All Phase IV requirements met, no constitution violations

## Project Structure

### Documentation (this feature)

```text
specs/006-minikube-helm-deployment/
├── plan.md              # This file (/sp.plan output)
├── research.md          # Phase 0 technology research (/sp.plan output)
├── data-model.md        # Phase 1 Kubernetes resource models (/sp.plan output)
├── quickstart.md        # Phase 1 deployment verification scenarios (/sp.plan output)
├── checklists/
│   └── requirements.md  # Spec quality validation (/sp.specify output)
└── tasks.md             # Phase 2 implementation tasks (/sp.tasks - NOT YET CREATED)
```

### Source Code (repository root)

```text
# Kubernetes deployment infrastructure (NEW for Phase 4)
k8s/
└── todo-app/                    # Helm chart directory
    ├── Chart.yaml               # Helm chart metadata
    ├── values.yaml              # Default configuration values
    └── templates/
        ├── _helpers.tpl         # Template helpers (labels, names)
        ├── deployment-frontend.yaml  # Frontend Deployment
        ├── deployment-backend.yaml   # Backend Deployment
        ├── service-frontend.yaml     # Frontend Service (NodePort)
        ├── service-backend.yaml      # Backend Service (ClusterIP)
        ├── configmap.yaml       # ConfigMap for non-sensitive config
        └── secret.yaml          # Secret for credentials (template only)

# Deployment automation (NEW for Phase 4)
scripts/
└── deploy.sh                    # One-command deployment script

# Documentation (NEW for Phase 4)
docs/
└── ai-devops-tools.md          # kubectl-ai, kagent, Docker AI guide

# Existing Phase 3 application (UNCHANGED)
backend/
├── src/
│   ├── models/         # Database models (Task, Conversation, Message)
│   ├── services/       # Business logic (task_service, conversation_service)
│   ├── api/            # REST endpoints
│   ├── routers/        # FastAPI routers (tasks, chat)
│   ├── agents/         # OpenAI Agents SDK (TodoAgent, factory)
│   └── mcp/            # MCP tools (add_task, list_tasks, complete_task, etc.)
├── tests/              # Backend tests (pytest)
└── Dockerfile          # Backend Docker image (UPDATED for health endpoints)

frontend/
├── src/
│   ├── app/            # Next.js App Router pages
│   ├── components/     # UI components (including ChatKit)
│   └── lib/            # API client, utilities
├── tests/              # Frontend tests (Jest)
└── Dockerfile          # Frontend Docker image (UPDATED for health endpoints)
```

**Structure Decision**: Extends existing web application (Phase 3) with Kubernetes deployment infrastructure. Helm chart follows standard layout with templates and values. Deployment script orchestrates workflow. Existing frontend/backend code minimally modified (only health endpoints added).

## Complexity Tracking

> **Fill ONLY if Constitution Check has violations that must be justified**

N/A - No constitution violations. All Phase IV requirements met without deviations.
