name: Deploy to Production (OKE)

on:
  push:
    branches:
      - main  # Trigger on merge to main branch
  workflow_dispatch:  # Allow manual trigger

env:
  REGISTRY: <OCIR_REGION>.ocir.io
  REGISTRY_USERNAME: <TENANCY_NAMESPACE>/<OCI_USERNAME>
  CLUSTER_NAME: todo-oke-cluster
  HELM_RELEASE: todo-app
  DAPR_VERSION: "1.12"

jobs:
  build-and-push:
    name: Build and Push Docker Images
    runs-on: ubuntu-latest
    outputs:
      image_tag: ${{ steps.meta.outputs.tags }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Oracle Cloud Infrastructure Registry (OCIR)
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ env.REGISTRY_USERNAME }}
          password: ${{ secrets.OCI_AUTH_TOKEN }}

      - name: Extract metadata for Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ secrets.TENANCY_NAMESPACE }}/todo
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=sha,prefix={{branch}}-

      - name: Build and push Backend image
        uses: docker/build-push-action@v5
        with:
          context: ./phase-5/backend
          file: ./phase-5/backend/Dockerfile
          push: true
          tags: ${{ env.REGISTRY }}/${{ secrets.TENANCY_NAMESPACE }}/todo-backend:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build and push Frontend image
        uses: docker/build-push-action@v5
        with:
          context: ./phase-5/frontend
          file: ./phase-5/frontend/Dockerfile
          push: true
          tags: ${{ env.REGISTRY }}/${{ secrets.TENANCY_NAMESPACE }}/todo-frontend:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build and push Recurring Task Service image
        uses: docker/build-push-action@v5
        with:
          context: ./phase-5/services/recurring-task-service
          file: ./phase-5/services/recurring-task-service/Dockerfile
          push: true
          tags: ${{ env.REGISTRY }}/${{ secrets.TENANCY_NAMESPACE}}/recurring-task-service:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build and push Notification Service image
        uses: docker/build-push-action@v5
        with:
          context: ./phase-5/services/notification-service
          file: ./phase-5/services/notification-service/Dockerfile
          push: true
          tags: ${{ env.REGISTRY }}/${{ secrets.TENANCY_NAMESPACE }}/notification-service:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  terraform-apply:
    name: Provision OKE Cluster
    runs-on: ubuntu-latest
    needs: build-and-push
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.0

      - name: Terraform Init
        working-directory: ./phase-5/terraform/oke
        run: terraform init

      - name: Terraform Plan
        working-directory: ./phase-5/terraform/oke
        env:
          TF_VAR_tenancy_ocid: ${{ secrets.OCI_TENANCY_OCID }}
          TF_VAR_user_ocid: ${{ secrets.OCI_USER_OCID }}
          TF_VAR_fingerprint: ${{ secrets.OCI_FINGERPRINT }}
          TF_VAR_private_key_path: ${{ secrets.OCI_PRIVATE_KEY_PATH }}
          TF_VAR_compartment_ocid: ${{ secrets.OCI_COMPARTMENT_OCID }}
          TF_VAR_region: ${{ secrets.OCI_REGION }}
        run: terraform plan -out=tfplan

      - name: Terraform Apply
        working-directory: ./phase-5/terraform/oke
        env:
          TF_VAR_tenancy_ocid: ${{ secrets.OCI_TENANCY_OCID }}
          TF_VAR_user_ocid: ${{ secrets.OCI_USER_OCID }}
          TF_VAR_fingerprint: ${{ secrets.OCI_FINGERPRINT }}
          TF_VAR_private_key_path: ${{ secrets.OCI_PRIVATE_KEY_PATH }}
          TF_VAR_compartment_ocid: ${{ secrets.OCI_COMPARTMENT_OCID }}
          TF_VAR_region: ${{ secrets.OCI_REGION }}
        run: terraform apply -auto-approve tfplan

  install-dapr:
    name: Install Dapr Runtime
    runs-on: ubuntu-latest
    needs: terraform-apply
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'v1.28.0'

      - name: Configure kubectl for OKE
        run: |
          mkdir -p $HOME/.kube
          echo "${{ secrets.OKE_KUBECONFIG }}" | base64 -d > $HOME/.kube/config

      - name: Install Dapr CLI
        run: |
          curl -fsSL https://raw.githubusercontent.com/dapr/cli/master/install/install.sh | bash
          sudo mv $HOME/.dapr/bin/dapr /usr/local/bin/dapr

      - name: Install Dapr to Kubernetes
        run: |
          dapr init -k --runtime-version ${{ env.DAPR_VERSION }} --enable-ha=true --enable-mtls=true --wait

      - name: Verify Dapr Installation
        run: |
          kubectl get pods -n dapr-system
          kubectl get components

  deploy-application:
    name: Deploy Application with Helm
    runs-on: ubuntu-latest
    needs: install-dapr
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'v1.28.0'

      - name: Configure kubectl for OKE
        run: |
          mkdir -p $HOME/.kube
          echo "${{ secrets.OKE_KUBECONFIG }}" | base64 -d > $HOME/.kube/config

      - name: Install Helm
        uses: azure/setup-helm@v3
        with:
          version: '3.13.0'

      - name: Deploy Helm Chart
        run: |
          helm upgrade --install ${{ env.HELM_RELEASE }} ./phase-5/helm/todo-app \
            -f ./phase-5/helm/todo-app/values-oke.yaml \
            --set backend.image.tag=${{ github.sha }} \
            --set frontend.image.tag=${{ github.sha }} \
            --set recurringTaskService.image.tag=${{ github.sha }} \
            --set notificationService.image.tag=${{ github.sha }} \
            --wait --timeout 15m

  health-checks:
    name: Run Health Checks
    runs-on: ubuntu-latest
    needs: deploy-application
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'v1.28.0'

      - name: Configure kubectl for OKE
        run: |
          mkdir -p $HOME/.kube
          echo "${{ secrets.OKE_KUBECONFIG }}" | base64 -d > $HOME/.kube/config

      - name: Wait for deployments to be ready
        run: |
          kubectl rollout status deployment/backend --timeout=10m
          kubectl rollout status deployment/frontend --timeout=10m
          kubectl rollout status deployment/recurring-task-service --timeout=10m
          kubectl rollout status deployment/notification-service --timeout=10m

      - name: Check pod status
        run: |
          kubectl get pods --all-namespaces
          kubectl wait --for=condition=ready pod --all --timeout=5m

      - name: Verify Dapr components
        run: |
          kubectl get components
          kubectl get configurations

  smoke-tests:
    name: Run Smoke Tests
    runs-on: ubuntu-latest
    needs: health-checks
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'v1.28.0'

      - name: Configure kubectl for OKE
        run: |
          mkdir -p $HOME/.kube
          echo "${{ secrets.OKE_KUBECONFIG }}" | base64 -d > $HOME/.kube/config

      - name: Test frontend health endpoint
        run: |
          kubectl port-forward service/frontend 3000:3000 &
          sleep 5
          curl -f http://localhost:3000/health || exit 1

      - name: Test backend health endpoint
        run: |
          kubectl port-forward service/backend 8000:8000 &
          sleep 5
          curl -f http://localhost:8000/health || exit 1

      - name: Verify Grafana metrics
        run: |
          kubectl port-forward service/grafana 3001:3000 &
          sleep 5
          curl -f http://localhost:3001/api/health || exit 1

  rollback:
    name: Rollback on Failure
    runs-on: ubuntu-latest
    needs: [health-checks, smoke-tests]
    if: failure()
    steps:
      - name: Install kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'v1.28.0'

      - name: Configure kubectl for OKE
        run: |
          mkdir -p $HOME/.kube
          echo "${{ secrets.OKE_KUBECONFIG }}" | base64 -d > $HOME/.kube/config

      - name: Install Helm
        uses: azure/setup-helm@v3
        with:
          version: '3.13.0'

      - name: Rollback Helm release
        run: |
          helm rollback ${{ env.HELM_RELEASE }} --wait --timeout 10m

      - name: Notify team of rollback
        uses: 8398a7/action-slack@v3
        with:
          status: failure
          text: 'Production deployment failed and was rolled back automatically'
          webhook_url: ${{ secrets.SLACK_WEBHOOK }}
        if: always()
