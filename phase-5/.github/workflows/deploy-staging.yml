name: Deploy to Staging (OKE)

on:
  push:
    branches:
      - develop  # Trigger on merge to develop branch
  workflow_dispatch:  # Allow manual trigger

env:
  REGISTRY: <OCIR_REGION>.ocir.io
  REGISTRY_USERNAME: <TENANCY_NAMESPACE>/<OCI_USERNAME>
  CLUSTER_NAME: todo-oke-staging
  HELM_RELEASE: todo-app-staging
  NAMESPACE: staging

jobs:
  build-and-deploy:
    name: Build and Deploy to Staging
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to OCIR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ env.REGISTRY_USERNAME }}
          password: ${{ secrets.OCI_AUTH_TOKEN }}

      - name: Build and push images
        run: |
          docker buildx build --push \
            -t ${{ env.REGISTRY }}/${{ secrets.TENANCY_NAMESPACE }}/todo-backend:staging-${{ github.sha }} \
            ./phase-5/backend

          docker buildx build --push \
            -t ${{ env.REGISTRY }}/${{ secrets.TENANCY_NAMESPACE }}/todo-frontend:staging-${{ github.sha }} \
            ./phase-5/frontend

          docker buildx build --push \
            -t ${{ env.REGISTRY }}/${{ secrets.TENANCY_NAMESPACE }}/recurring-task-service:staging-${{ github.sha }} \
            ./phase-5/services/recurring-task-service

          docker buildx build --push \
            -t ${{ env.REGISTRY }}/${{ secrets.TENANCY_NAMESPACE }}/notification-service:staging-${{ github.sha }} \
            ./phase-5/services/notification-service

      - name: Install kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'v1.28.0'

      - name: Configure kubectl
        run: |
          mkdir -p $HOME/.kube
          echo "${{ secrets.OKE_KUBECONFIG_STAGING }}" | base64 -d > $HOME/.kube/config

      - name: Create staging namespace
        run: |
          kubectl create namespace ${{ env.NAMESPACE }} --dry-run=client -o yaml | kubectl apply -f -

      - name: Install Helm
        uses: azure/setup-helm@v3
        with:
          version: '3.13.0'

      - name: Deploy to staging
        run: |
          helm upgrade --install ${{ env.HELM_RELEASE }} ./phase-5/helm/todo-app \
            -f ./phase-5/helm/todo-app/values-oke.yaml \
            --namespace ${{ env.NAMESPACE }} \
            --set backend.image.tag=staging-${{ github.sha }} \
            --set frontend.image.tag=staging-${{ github.sha }} \
            --set global.environment=staging \
            --wait --timeout 10m

      - name: Run integration tests
        run: |
          kubectl run integration-tests \
            --namespace ${{ env.NAMESPACE }} \
            --image=${{ env.REGISTRY }}/${{ secrets.TENANCY_NAMESPACE }}/todo-tests:latest \
            --restart=Never --rm -it -- pytest tests/integration/

      - name: Notify team
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          text: 'Staging deployment completed successfully'
          webhook_url: ${{ secrets.SLACK_WEBHOOK }}
        if: always()
